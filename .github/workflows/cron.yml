name: Ejecutar Bot Clasificados

on:
  # Ejecutar cada 1 minuto (¡Ojo! GitHub Actions a veces no permite intervalos tan cortos,
  # y puede limitar la ejecución real a ~5 minutos mínimo, dependiendo de su política)
  schedule:
    - cron: "*/1 * * * *"

  # Permite disparar manualmente desde la pestaña Actions
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # Otorga permisos de escritura al contenido del repo
    permissions:
      contents: write

    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3
        with:
          # Forzamos a usar el GITHUB_TOKEN integrado
          token: ${{ secrets.GITHUB_TOKEN }}
          # Evita que se usen credenciales por defecto y fuerza a usar el token
          persist-credentials: false

      - name: Configurar Git (para que podamos hacer commit)
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Instalar dependencias
        run: |
          pip install requests beautifulsoup4 urllib3

      - name: Ejecutar Bot
        run: |
          python clasificados.py

      - name: Guardar cambios (si listings.txt cambió)
        run: |
          # Agregamos listings.txt al "stage"
          git add listings.txt

          # Solo hacemos commit si hay cambios (si 'diff' no está vacío)
          git diff --quiet --exit-code listings.txt || git commit -m "Update listings [skip ci]"

          # Empujamos el commit al repos usando el token del entorno
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
